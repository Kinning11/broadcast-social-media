@using Microsoft.AspNetCore.Identity
@using System.Security.Claims
@model UsersShowUserViewModel
@inject UserManager<ApplicationUser> UserManager

@{
    var currentUser = await UserManager.GetUserAsync(User);
    ViewData["Title"] = Model.User.Name;
}

<div class="feed-container">

    
    <div class="broadcast-card recommended-user">

        <div class="recommended-user-info">
            @if (!string.IsNullOrEmpty(Model.User.ProfileImagePath))
            {
                <img src="@Model.User.ProfileImagePath"
                     class="profile-image" />
            }
            else
            {
                <img src="/images/default-profile.png"
                     class="profile-image" />
            }

            <h2>@Model.User.Name</h2>
        </div>

        @if (currentUser.Id != Model.User.Id)
        {
            <form method="post"
                  action="@(Model.IsFollowing ? "/Users/UnListen" : "/Users/Listen")">

                <input type="hidden"
                       name="UserId"
                       value="@Model.User.Id" />

                <button type="submit" class="follow-button">
                    @(Model.IsFollowing ? "Unfollow" : "Follow")
                </button>
            </form>
        }

    </div>

    <h3 class="broadcast-h">
        Broadcasts from @Model.User.Name
    </h3>

    
    @foreach (var broadcast in Model.Broadcasts)
    {
        <div class="broadcast-card">

            <div class="broadcast-header">
                <span>
                    @broadcast.Published.ToShortDateString()
                    @broadcast.Published.ToShortTimeString()
                </span>
            </div>

            <div class="broadcast-message">
                @broadcast.Message
            </div>

            @if (!string.IsNullOrEmpty(broadcast.ImagePath))
            {
                <div class="broadcast-image">
                    <img src="@broadcast.ImagePath" />
                </div>
            }

            <div class="broadcast-actions">

                <span class="like-count">
                    @broadcast.Likes.Count Likes
                </span>

                @{
                    var currentUserId = User.FindFirstValue(ClaimTypes.NameIdentifier);
                    var isLiked = broadcast.Likes.Any(l => l.UserId == currentUserId);
                }

                <button class="like-btn"
                        data-broadcast-id="@broadcast.Id">
                    @(isLiked ? "🤍 Unlike" : "❤️ Like")
                </button>

            </div>

        </div>
    }

</div>